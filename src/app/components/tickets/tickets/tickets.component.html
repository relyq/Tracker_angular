<div *ngIf="project">
  <div class="flex-card">
    <app-project-detail [users]="users"></app-project-detail>

    <span class="flex-span"></span>

    <mat-slide-toggle color="primary" [(ngModel)]="cards"
      >Cards</mat-slide-toggle
    >
  </div>

  <mat-card class="card-container">
    <div class="flex-card">
      <button mat-raised-button (click)="showStatus('Open')">Open</button>
      <button mat-raised-button (click)="showStatus('Closed')">Closed</button>
      <button mat-raised-button (click)="showStatus('')">All</button>

      <button
        *ngIf="canCreate"
        mat-raised-button
        color="primary"
        routerLink="/project/{{ project.id }}/ticket/create"
      >
        New Ticket +
      </button>

      <span class="flex-span"> </span>

      <mat-form-field>
        <mat-label>Search</mat-label>
        <input
          matInput
          name="search"
          autocomplete="off"
          (keyup)="filter($event, dataSource)"
          [(ngModel)]="search"
          (ngModelChange)="filterCards($event)"
          #input
        />
      </mat-form-field>
    </div>

    <mat-divider></mat-divider>

    <div *ngIf="project && tickets && users">
      <mat-grid-list *ngIf="cards" [cols]="4" rowHeight="40px" gutterSize="5px">
        <mat-grid-tile
          *ngFor="let ticket of filteredTickets"
          colspan="1"
          rowspan="4"
        >
          <mat-card
            class="ticket-card"
            [ngClass]="getPriority(ticket.priority).toLowerCase()"
            routerLink="/project/{{ project.id }}/ticket/{{ ticket.id }}"
          >
            <mat-card-subtitle class="flex-card">
              {{ ticket.id }} - {{ ticket.type }}
              <span class="flex-span"></span>
              <div *ngIf="users">
                {{ getUsername(ticket.submitterId) }}
              </div>
            </mat-card-subtitle>

            <mat-card-title>{{ ticket.title }}</mat-card-title>

            <mat-card-content class="description">
              <p [innerText]="ticket.description"></p>
            </mat-card-content>

            <mat-divider inset></mat-divider>

            <mat-card-actions class="flex-card">
              {{
                ticket.closed
                  ? (ticket.closed + "Z" | date: "MMM d, y, HH:mm")
                  : (ticket.created + "Z" | date: "MMM d, y, HH:mm")
              }}
              <span class="flex-span"></span>
              {{ getPriority(ticket.priority) + " - " + ticket.status }}
            </mat-card-actions>
          </mat-card>
        </mat-grid-tile>
      </mat-grid-list>

      <table mat-table [dataSource]="dataSource" *ngIf="!cards" matSort>
        <ng-contatiner matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>ID</th>
          <td mat-cell *matCellDef="let ticket">
            {{ ticket.id }}
          </td>
        </ng-contatiner>

        <ng-contatiner matColumnDef="title">
          <th mat-header-cell *matHeaderCellDef>Title</th>
          <td mat-cell *matCellDef="let ticket">
            {{ ticket.title }}
          </td>
        </ng-contatiner>

        <ng-contatiner matColumnDef="description">
          <th mat-header-cell *matHeaderCellDef>Description</th>
          <td mat-cell *matCellDef="let ticket" class="truncate">
            {{ ticket.description }}
          </td>
        </ng-contatiner>

        <ng-contatiner matColumnDef="priority">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Priority</th>
          <td mat-cell *matCellDef="let ticket">
            {{ getPriority(ticket.priority) }}
          </td>
        </ng-contatiner>

        <ng-contatiner matColumnDef="type">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Type</th>
          <td mat-cell *matCellDef="let ticket">
            {{ ticket.type }}
          </td>
        </ng-contatiner>

        <mat-text-column name="status"></mat-text-column>

        <ng-contatiner matColumnDef="submitter">
          <th mat-header-cell *matHeaderCellDef>Submitter</th>
          <td mat-cell *matCellDef="let ticket">
            {{ getUsername(ticket.submitterId) }}
          </td>
        </ng-contatiner>

        <ng-contatiner matColumnDef="assignee">
          <th mat-header-cell *matHeaderCellDef>Assignee</th>
          <td mat-cell *matCellDef="let ticket">
            {{ getUsername(ticket.assigneeId) }}
          </td>
        </ng-contatiner>

        <ng-container matColumnDef="activity">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Activity</th>
          <td mat-cell *matCellDef="let ticket">
            {{
              ticket.activity
                ? (ticket.activity + "Z" | date: "MMM d, y, HH:mm")
                : ""
            }}
          </td>
        </ng-container>

        <ng-container matColumnDef="closed">
          <th
            mat-header-cell
            *matHeaderCellDef
            mat-sort-header
            [hidden]="!closed"
          >
            Closed
          </th>
          <td mat-cell *matCellDef="let ticket" [hidden]="!closed">
            {{
              ticket.closed
                ? (ticket.closed + "Z" | date: "MMM d, y, HH:mm")
                : ""
            }}
          </td>
        </ng-container>

        <ng-container matColumnDef="created">
          <th mat-header-cell *matHeaderCellDef mat-sort-header>Created</th>
          <td mat-cell *matCellDef="let ticket">
            {{ ticket.created + "Z" | date: "MMM d, y, HH:mm" }}
          </td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr
          mat-row
          class="row"
          *matRowDef="let ticket; columns: displayedColumns"
          [ngClass]="getPriority(ticket.priority).toLowerCase()"
          routerLink="/project/{{ project.id }}/ticket/{{ ticket.id }}"
        ></tr>
      </table>
    </div>
  </mat-card>
</div>
